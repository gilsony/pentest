# -*- coding: utf-8 -*-

from slacker import Slacker
import os
import sys
import time
import feedparser
import requests

#################
# CONFIGURATION #
#################
feedurl_file = './url.txt'
feeds_db = './feeds.db'

current_time_millisec = lambda: int(round(time.time() * 1000))
current_timestamp = current_time_millisec()

def feed_is_in_db(feed_title):
    try:
        mode = 'r' if os.path.exists(feeds_db) else open(feeds_db, 'w')
        with open(feeds_db, mode) as database:
            for line in database:
                if feed_title in line:
                    return True
        return False
    except:
        pass


def load_feeds():
    try:
        if os.path.exists(feedurl_file):
            f = open(feedurl_file, 'r')
            for n,line in enumerate(f.read().split('\n')):
                _FEED_NAME = line.split(',')[0]
                url = line.split(',')[-1]
                get_feed(url)
            f.close()
        else:
            print('[-] RSS Feed file not found.! check %s' % feedurl_file)
    except Exception as e:
         print(e)


def get_feed(url):
    feed = feedparser.parse(url)
    message = ""
    mode = 'a' if os.path.exists(feeds_db) else open(feeds_db, 'w')
    with open(feeds_db, mode) as fa:
        for post in feed.entries:
            feed_title = str(post.title.encode('utf-8'))
            if not feed_is_in_db(feed_title):
                fa.write(feed_title + ' | ' + str(current_timestamp) + '\n')
                feed_title_LINK = '[+] ' + post.title + ' - ' + post.link + '\n'
                message += feed_title_LINK
    fa.close()
    
    if message:
        date = time.strftime('%Y-%m-%d')
        message = '*%s New Exploits *\n\n%s' % ( date, message)

       ######## 슬랙 전송 #############
        send_to_slack('xoxb-9689029845-868389858387-TWJpLnJu6EghndAK1DU13Qza','#message_test',message)
        #send_to_slack('xoxb-7909278821-516462667703-8nGZZwNJ4ERkMa9q7VDvXXQ9','#zin_exploits',message)

        print('==== New feeds ==== \n%s' % message)


def send_to_slack(token,channel,msg):
    slack = Slacker(token)
    slack.chat.post_message(channel, msg)


def main():
    load_feeds()


if __name__ == '__main__':
    main()

