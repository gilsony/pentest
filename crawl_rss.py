# -*- coding: utf-8 -*-

from slacker import Slacker
import datetime
import os
import time
import feedparser

feedurl_file = './url.txt'

def load_feeds():
    try:
        if os.path.exists(feedurl_file):
            f = open(feedurl_file, 'r')
            for n,line in enumerate(f.read().split('\n')):
                _FEED_NAME = line.split(',')[0]
                url = line.split(',')[-1]
                crawl_rss(url)
            f.close()
        else:
            print('[-] RSS Feed file not found.! check %s' % feedurl_file)
    except Exception as e:
        print(e)

def crawl_rss(url):
    feed = feedparser.parse(url)
    message = ""

    for post in feed.entries:
        xml_date = post.published
        cvt_date = datetime.datetime.strptime(xml_date, '%a, %d %b %Y %H:%M:%S %z')
        oneday = datetime.timedelta(days=1)
        now = datetime.datetime.now()
        yesterday = str(now - oneday)[:10]

        if yesterday in str(cvt_date):
            feed_title = str(post.title.encode('utf-8'))
            feed_title_LINK = '[+] ' + post.title + ' - ' + post.link + '\n'
            message += feed_title_LINK

    if message:
        date = time.strftime('%Y-%m-%d')
        message = '*%s New Exploits *\n\n%s' % (date, message)

        ######## 슬랙 전송 #############
        send_to_slack('slack-auth-key','#channel-name',message)
        print('==== New feeds ==== \n%s' % message)

def send_to_slack(token,channel,msg):
    slack = Slacker(token)
    slack.chat.post_message(channel, msg)

def main():
    load_feeds()

if __name__ == '__main__':
    main()
